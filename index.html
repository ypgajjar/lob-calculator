<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FMVJG9076Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FMVJG9076Z');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Line of Balance (LOB) Scheduler & Analyzer</title>
  <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Aldrich&family=Exo+2:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    /* CSS from the previously confirmed working version - UNCHANGED */
    :root {
      --bg-main: #F4F6F8;
      --bg-panel: #FFFFFF;
      --bg-panel-accent: #E9ECEF;
      --bg-header: #FFFFFF;

      --accent-primary: #007BFF;
      --accent-secondary: #FD7E14;
      --accent-positive: #28A745;
      --accent-neutral: #6c757d;
      --accent-danger: #dc3545;

      --text-primary: #212529;
      --text-secondary: #495057;
      --text-muted: #6c757d;
      --text-on-accent-button: #FFFFFF;
      --text-header-brand: var(--accent-primary);

      --font-display: 'Aldrich', sans-serif;
      --font-main: 'Exo 2', sans-serif;
      --font-mono: 'Roboto Mono', monospace;

      --border-color: rgba(0, 123, 255, 0.25);
      --border-color-light: rgba(0, 0, 0, 0.1);
      --border-radius: 5px;
      --transition-main: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --shadow-panel: 0 6px 12px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0,0,0,0.05);
      --shadow-interactive: 0 2px 5px rgba(0, 123, 255, 0.2);
      --shadow-header: 0 2px 4px rgba(0,0,0,0.07);
    }

    body {
      font-family: var(--font-main);
      background-color: var(--bg-main);
      color: var(--text-primary);
      font-size: 15px;
      line-height: 1.6;
      margin-top: 70px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app-header { position: fixed; top: 0; left: 0; width: 100%; background-color: var(--bg-header); box-shadow: var(--shadow-header); padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center; z-index: 1000; border-bottom: 1px solid var(--border-color-light); }
    .app-header .brand { font-family: var(--font-display); font-size: 1.6rem; color: var(--text-header-brand); display: flex; align-items: center; }
    .app-header .brand i { margin-right: 0.75rem; font-size: 1.3em; }
    .app-header .project-controls button { margin-left: 0.5rem; font-size: 0.8rem; padding: 0.4rem 0.8rem; }
    .lob-container { background-color: var(--bg-panel); border: 1px solid var(--border-color); box-shadow: var(--shadow-panel); border-radius: var(--border-radius); margin-top: 1.5rem; }
    h1.page-title { font-family: var(--font-display); color: var(--accent-primary); text-shadow: 1px 1px 1px rgba(0,0,0,0.05); padding-bottom: 0.75rem; border-bottom: 2px solid var(--accent-primary); margin-bottom: 1.5rem !important; }
    h2, h3.font-semibold { font-family: var(--font-main); font-weight: 600; color: var(--accent-primary); border-bottom: 1px solid var(--border-color-light); padding-bottom: 0.5rem; margin-bottom: 1rem !important; }
    
    .form-section, .summary-section, .wbs-section {
      background-color: var(--bg-panel-accent); 
      border: 1px solid var(--border-color-light); 
      border-radius: var(--border-radius); 
      padding: 1.25rem; 
    }
    .chart-section {
      background-color: var(--bg-panel);
      border: 1px solid var(--border-color-light); 
      border-radius: var(--border-radius); 
      padding: 1.25rem; 
    }

    .floating-input { position: relative; margin-bottom: 1.25rem; overflow: visible; z-index: 1; }
    .floating-input input[type="text"], .floating-input input[type="number"], .floating-input input[type="date"] { border: none; border-bottom: 2px solid var(--border-color-light); width: 100%; padding: 0.9rem 0.25rem 0.4rem 0.25rem; background: transparent; font-size: 0.9rem; outline: none; transition: border-color 0.3s; color: var(--text-primary); border-radius: 0; box-sizing: border-box; }
    .floating-input input[type="text"]:focus, .floating-input input[type="number"]:focus, .floating-input input[type="date"]:focus { border-color: var(--accent-primary); }
    
    .floating-input label { 
        position: absolute; left: 0.25rem; top: 0.9rem; 
        font-size: 0.9rem; color: var(--text-muted); pointer-events: none; 
        transition: all 0.2s ease-out; 
        background-color: var(--bg-panel-accent); 
        padding: 0 0.25rem; line-height: 1; transform-origin: left top; 
    }
    .floating-input input:focus + label, .floating-input input:not(:placeholder-shown) + label { 
        transform: translateY(-1.55rem) scale(0.8); color: var(--accent-primary); 
    }
    .floating-input input[type="date"]:not([value=""]):not(:placeholder-shown) + label, .floating-input input[type="date"]:focus + label { 
        transform: translateY(-1.55rem) scale(0.8); color: var(--accent-primary); 
    }

    .tooltip-icon { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: var(--text-muted); cursor: help; font-size: 0.9rem; z-index: 2; }
    .tooltip-text { visibility: hidden; width: max-content; max-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: var(--border-radius); padding: 5px 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; pointer-events: none; }
    .tooltip-icon:hover + .tooltip-text { visibility: visible; opacity: 1; }
    select.pred-activity-select, select.dependency-type-select, input.form-input { border: 1px solid var(--border-color-light) !important; border-radius: var(--border-radius) !important; padding: 0.5rem 0.75rem !important; font-size: 0.9rem !important; background-color: var(--bg-panel) !important; color: var(--text-primary) !important; transition: border-color 0.3s; box-shadow: none !important; height: 38px; box-sizing: border-box; }
    select.pred-activity-select:focus, select.dependency-type-select:focus, input.form-input:focus { border-color: var(--accent-primary) !important; outline: 2px solid transparent !important; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2) !important; }
    .themed-button { font-family: var(--font-main); font-weight: 600; padding: 0.65rem 1.25rem; border-radius: var(--border-radius); text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.85rem; transition: all 0.3s ease; box-shadow: var(--shadow-interactive); border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
    .themed-button i { margin-right: 0.5rem; }
    .themed-button-primary { background: linear-gradient(45deg, var(--accent-primary), #0056b3); color: var(--text-on-accent-button); }
    .themed-button-primary:hover { background: linear-gradient(45deg, #0056b3, var(--accent-primary)); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3); }
    .themed-button-secondary { background-color: var(--accent-neutral); color: var(--text-on-accent-button); }
    .themed-button-secondary:hover { background-color: #5a6268; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .themed-button-tertiary { background-color: var(--bg-panel-accent); color: var(--text-secondary); border: 1px solid var(--border-color); box-shadow: none; font-weight: 500; padding: 0.5rem 1rem; text-transform: none; }
    .themed-button-tertiary:hover { background-color: #dde1e6; border-color: var(--accent-primary); color: var(--accent-primary); }
    .themed-button-danger { background-color: var(--accent-danger); color: var(--text-on-accent-button); }
    .themed-button-danger:hover { background-color: #c82333; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3); }
    .summary-section { border-color: var(--accent-primary); }
    .summary-section h3 { color: var(--accent-primary); border-bottom-color: rgba(0, 123, 255, 0.2); }
    .summary-section div > strong { color: var(--text-primary); }
    .summary-section div > span { color: var(--text-secondary); }
    
    #activity-list-container ul { list-style: none; padding-left: 0; }
    #activity-list-container .bg-white {
      background-color: var(--bg-panel) !important; 
      border: 1px solid var(--border-color-light);
      border-left-width: 5px; 
      border-left-style: solid;
      border-radius: var(--border-radius); margin-bottom: 0.5rem !important;
      padding: 0.6rem !important;
      transition: box-shadow 0.2s, border-color 0.2s, border-left-color 0.2s; 
    }
    #activity-list-container .bg-white:hover {
      border-color: var(--accent-primary); 
      box-shadow: 0 2px 5px rgba(0,123,255,0.15);
    }

    #activity-list-container .text-xs { font-size: 0.8rem !important; }
    #activity-list-container strong { color: var(--text-primary); font-weight: 600; }
    #activity-list-container .text-gray-500 { color: var(--text-muted) !important; }
    #activity-list-container ul > li > ul.ml-4 { margin-left: 1rem !important; padding-left: 1rem !important; border-left: 1px solid var(--border-color-light) !important; }
    #activity-list-container .w-3.h-3 { width: 0.6rem; height: 0.6rem; } 

    .control-btn { background: none; border: 1px solid transparent; padding: 0.2rem 0.4rem; margin-left: 0.25rem; cursor: pointer; font-size: 0.75rem; border-radius: 3px; transition: background-color 0.2s, color 0.2s, border-color 0.2s; font-family: var(--font-main); display: inline-flex; align-items: center; }
    .control-btn i { margin-right: 0.25rem;}
    .edit-btn { color: var(--accent-primary); border-color: rgba(0, 123, 255, 0.2); }
    .edit-btn:hover { background-color: rgba(0, 123, 255, 0.1); border-color: var(--accent-primary); }
    .delete-btn { color: var(--accent-danger); border-color: rgba(220, 53, 69, 0.2); }
    .delete-btn:hover { background-color: rgba(220, 53, 69, 0.1); border-color: var(--accent-danger); }
    .activity-list::-webkit-scrollbar, #dependency-links-container::-webkit-scrollbar { width: 6px; }
    .activity-list::-webkit-scrollbar-track, #dependency-links-container::-webkit-scrollbar-track { background: var(--bg-panel-accent); border-radius: 10px; }
    .activity-list::-webkit-scrollbar-thumb, #dependency-links-container::-webkit-scrollbar-thumb { background: var(--accent-neutral); border-radius: 10px; }
    .activity-list::-webkit-scrollbar-thumb:hover, #dependency-links-container::-webkit-scrollbar-thumb:hover { background: #5a6268; }
    .chartjs-tooltip { background: rgba(0, 0, 0, 0.75); color: white; border-radius: var(--border-radius); padding: 0.5rem 0.75rem; font-size: 0.8rem; font-family: var(--font-main); pointer-events: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    
    .project-start-section { 
      border-radius: var(--border-radius); 
      border: 1px solid var(--border-color-light); 
    }
    label[for="project-start-date-input"] { font-weight: 500; color: var(--text-secondary); }
    #global-message-area { padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: var(--border-radius); font-size: 0.9rem; display: none; }
    #global-message-area.success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
    #global-message-area.error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
    #global-message-area.info { background-color: #cff4fc; color: #055160; border: 1px solid #b6effb; }
    
    fieldset.dependencies-fieldset { 
        border: 1px solid var(--border-color-light); border-top-width: 1px !important; 
        padding: 1rem; margin-top: 1rem; border-radius: var(--border-radius); 
        background-color: var(--bg-panel); 
    }
    fieldset.dependencies-fieldset legend { font-family: var(--font-main); font-weight: 600; color: var(--accent-primary); padding: 0 0.5rem; font-size: 1.1em; margin-bottom: 0.75rem; width: auto; }
    #dependency-links-container { padding-right: 0.25rem; margin-bottom: 0.75rem; }
    #dependency-links-container > .dependency-row { 
        margin-bottom: 0.75rem; 
        background-color: var(--bg-panel); 
        padding: 0.5rem; border-radius: var(--border-radius); border: 1px solid var(--border-color-light); 
    }
    #add-dependency-btn.themed-button-tertiary { width: 100%; box-sizing: border-box; margin-top: 0.5rem; }

    .dependency-row { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; width: 100%; box-sizing: border-box; }
    .dependency-row .pred-activity-select { flex-grow: 1; flex-shrink: 1; min-width: 120px; flex-basis: 150px; }
    .dependency-row .dependency-type-select { flex-shrink: 0; width: 75px; }
    .dependency-row .floating-input { flex-shrink: 1; min-width: 60px; width: 70px; height: 38px; box-sizing: border-box; display: flex; align-items: center; position: relative; overflow: visible; z-index: 1;}
    .dependency-row .remove-dependency-btn { flex-shrink: 0; width: 38px; }

    .dependency-row .floating-input input.dependency-lag-input { padding: 0.85rem 0.25rem 0.35rem 0.25rem; width: 100%; background: transparent; }
    .dependency-row .floating-input input.dependency-lag-input:focus { border-color: var(--accent-primary); }

    .dependency-row .floating-input label {
        position: absolute; left: 0.3rem; top: 0.85rem;
        font-size: 0.8rem; color: var(--text-muted); pointer-events: none;
        transition: all 0.2s ease-out;
        background-color: var(--bg-panel); 
        padding: 0 0.25rem; line-height: 1;
        transform-origin: left top; white-space: nowrap; z-index: 2;
    }
    .dependency-row .floating-input input:focus + label,
    .dependency-row .floating-input input:not(:placeholder-shown) + label {
        top: 2px; transform: none !important;
        font-size: 0.75rem; color: var(--accent-primary);
    }

    .dependency-row .remove-dependency-btn { justify-content: center; padding: 0; border: 1px solid transparent; }
    .dependency-row .remove-dependency-btn:hover { background-color: rgba(220, 53, 69, 0.1); border-color: rgba(220, 53, 69, 0.2); }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">
        <i class="fas fa-wave-square"></i>
        <span>LOB Scheduler</span>
    </div>
    <div class="project-controls">
        <button id="save-project-btn" class="themed-button themed-button-tertiary" title="Save Project Data to this Browser (Local Storage)">
            <i class="fas fa-save"></i> Save
        </button>
        <button id="load-project-btn" class="themed-button themed-button-tertiary" title="Load Project from this Browser (Local Storage)">
          <i class="fas fa-folder-open"></i> Load
        </button>
        <button id="reset-project-btn" class="themed-button themed-button-tertiary" title="Reset Project Data to a new, empty project">
            <i class="fas fa-undo"></i> Reset
        </button>
        <button id="export-json-btn" class="themed-button themed-button-tertiary" title="Export Project to a JSON file (for backup or transfer)">
            <i class="fas fa-file-export"></i> Export JSON
        </button>
        <button id="import-json-btn" class="themed-button themed-button-tertiary" title="Import Project from a JSON file">
            <i class="fas fa-file-import"></i> Import JSON
        </button>
        <button id="export-csv-btn" class="themed-button themed-button-tertiary" title="Export Activities to CSV (data only, not full project)">
            <i class="fas fa-file-csv"></i> Export CSV
        </button>
        <button id="export-pdf-btn" class="themed-button themed-button-tertiary" title="Export Report to PDF">
            <i class="fas fa-file-pdf"></i> Export PDF
        </button>
    </div>
    <div id="loadProjectModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 2000;">
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
          <h3 class="text-xl font-semibold mb-4">Load Saved Project</h3>
          <select id="savedProjectsSelect" class="w-full p-2 border rounded-md mb-4">
              <option value="">-- Select a Project --</option>
          </select>
          <div class="flex justify-end space-x-2">
              <button id="confirmLoadProject" class="themed-button themed-button-primary">Load</button>
              <button id="cancelLoadProject" class="themed-button themed-button-secondary">Cancel</button>
              <button id="deleteSavedProject" class="themed-button themed-button-danger" title="Delete selected project" style="display:none;"><i class="fas fa-trash"></i></button>
          </div>
      </div>
    </div>
  </header>
  <input type="file" id="json-file-input" accept=".json" style="display: none;" />

  <main class="container mx-auto max-w-7xl p-4 md:p-6">
    <div class="lob-container p-6 rounded-lg space-y-8">
        <h1 class="page-title text-2xl md:text-3xl font-bold text-center">
        Line of Balance (LOB) Scheduler & Analyzer
        </h1>
        <div id="global-message-area" role="alert"></div>
        <section class="project-start-section mb-6 p-4 rounded-lg flex items-center space-x-4" aria-labelledby="project-start-label">
            <label id="project-start-label" for="project-start-date-input" class="block text-sm font-medium">
                Project Start Date:
            </label>
            <input type="date" id="project-start-date-input" class="form-input px-3 py-2" aria-describedby="project-start-desc" />
            <small id="project-start-desc" class="text-xs text-gray-500 ml-2">All activity dates are relative to this.</small>
        </section>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <section class="md:col-span-1 p-5 rounded-lg self-start form-section" aria-labelledby="activity-form-heading">
            <h2 id="activity-form-heading" class="text-xl font-semibold text-gray-700">Add/Edit Activity</h2>
            <form id="activity-form" class="space-y-3" aria-live="polite">
            <div class="floating-input">
                <input type="text" id="wbs-code" placeholder=" " required
                    pattern="^[0-9]+(\.[0-9]+)*$"
                    title="Use numbers and dots only (e.g., 1.1.2)" aria-required="true" />
                <label for="wbs-code">WBS Code</label>
                <i class="fas fa-info-circle tooltip-icon" aria-hidden="true"></i>
                <span class="tooltip-text">Hierarchical code, e.g., 1.1 or 2.3.4</span>
            </div>
            <div class="floating-input">
                <input type="text" id="activity-name" placeholder=" " required aria-required="true" />
                <label for="activity-name">Activity Name</label>
            </div>
            <div class="floating-input">
                <input type="number" id="overall-duration" placeholder=" " required min="0.1" step="0.1" aria-required="true" />
                <label for="overall-duration">Overall Duration (days)</label>
                 <i class="fas fa-info-circle tooltip-icon" aria-hidden="true"></i>
                <span class="tooltip-text">Total time from start of first unit to end of last unit for this activity.</span>
            </div>
            <div class="floating-input">
                <input type="date" id="activity-start-date" placeholder=" " aria-describedby="manual-start-desc"/>
                <label for="activity-start-date">Manual Start Date (Optional)</label>
                <small id="manual-start-desc" class="text-xs text-gray-500 sr-only">Overrides dependency calculations if later.</small>
            </div>
            <div class="floating-input">
                <input type="number" id="num-units" placeholder=" " required min="1" step="1" aria-required="true" />
                <label for="num-units">Number of Units</label>
                <i class="fas fa-info-circle tooltip-icon" aria-hidden="true"></i>
                <span class="tooltip-text">Total number of repetitive units for this activity (e.g., floors, rooms).</span>
            </div>
            <div class="floating-input">
                <input type="number" id="start-unit" placeholder=" " required min="1" step="1" value="1" aria-required="true" />
                <label for="start-unit">Start Unit (Informational)</label>
                <i class="fas fa-info-circle tooltip-icon" aria-hidden="true"></i>
                <span class="tooltip-text">Typically 1. The first unit on the LOB chart y-axis for this activity.</span>
            </div>
            <fieldset class="dependencies-fieldset border-t pt-4 mt-4" style="border-color: var(--border-color-light);">
                <legend class="text-lg font-semibold mb-3 text-gray-700 w-full">Dependency Links</legend>
                <div id="dependency-links-container" class="space-y-3 mb-3 max-h-48 overflow-y-auto pr-2" aria-live="polite">
                </div>
                <button type="button" id="add-dependency-btn" class="w-full themed-button themed-button-tertiary text-sm">
                <i class="fas fa-plus-circle"></i> Add Dependency
                </button>
            </fieldset>
            <button id="submit-button" type="submit" class="w-full themed-button themed-button-primary">
                <i class="fas fa-check-circle"></i> Add Activity
            </button>
            <button id="cancel-edit-button" type="button" onclick="cancelEdit()" class="w-full mt-2 themed-button themed-button-secondary" style="display: none;">
                <i class="fas fa-times-circle"></i> Cancel Edit
            </button>
            </form>
        </section>
        <div class="md:col-span-2 flex flex-col space-y-4">
            <section class="p-4 rounded-lg summary-section" aria-labelledby="project-summary-heading">
            <h3 id="project-summary-heading" class="text-lg font-semibold mb-2">Project Summary</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm">
                <div><strong>Start Date:</strong> <span id="project-start-date">-</span></div>
                <div><strong>End Date:</strong> <span id="project-end-date">-</span></div>
                <div><strong>Duration:</strong> <span id="project-duration">-</span> days</div>
            </div>
            </section>
            <section class="p-5 rounded-lg flex-grow flex flex-col wbs-container wbs-section" aria-labelledby="wbs-view-heading">
            <h2 id="wbs-view-heading" class="text-xl font-semibold text-gray-700">Activities (WBS View)</h2>
            <p id="no-activities-message" class="text-gray-500 italic mb-2" style="display: block;">No activities added yet.</p>
            <div id="activity-list-container" class="activity-list wbs-list flex-grow overflow-y-auto pr-2 border-t pt-2" style="display: none; border-color: var(--border-color-light);" role="tree">
            </div>
            </section>
        </div>
        </div>
        <section class="p-5 rounded-lg shadow-sm chart-section" aria-labelledby="lob-chart-heading">
        <h2 id="lob-chart-heading" class="text-xl font-semibold mb-4 text-center">Line of Balance Chart</h2>
        <div class="relative h-96 md:h-[500px]">
            <canvas id="lob-chart" role="img" aria-label="Line of Balance Chart visualizing activity progress over time and units."></canvas>
        </div>
        </section>
        <section class="p-5 rounded-lg shadow-sm mt-8 chart-section" aria-labelledby="gantt-chart-heading">
        <h2 id="gantt-chart-heading" class="text-xl font-semibold mb-4 text-center">Gantt Chart</h2>
        <div id="gantt-chart-container" class="relative h-[600px]">
            <canvas id="gantt-chart" role="img" aria-label="Gantt chart displaying activity timelines."></canvas>
        </div>
        </section>
    </div>
  </main>
  <script>
    // --- ALL JAVASCRIPT FROM PREVIOUS RESPONSE WITH NEW MODIFICATIONS ---
    // --- (resetProject, PDF report enhancements, chart axis extension, JSON import/export) ---
    console.log("Initializing Elegant LOB Tool (v10.1 - Full Script)...");
    let activities = [];
    let lobChartInstance = null;
    let ganttChartInstance = null;
    const colors = ['#4f46e5','#db2777','#16a34a','#ca8a04','#0ea5e9','#d97706','#6d28d9','#059669','#dc2626','#64748b', '#7e22ce', '#0891b2', '#52525b', '#f97316', '#be185d'];
    let colorIndex = 0;
    let editingActivityId = null;
    let projectStartDate = new Date();
    let form, submitButton, cancelEditButton, noActivitiesMessage, activityListContainer,
        projectStartDateEl, projectEndDateEl, projectDurationEl, lobCtx, ganttCtx;
    let wbsCodeInput, nameInput, overallDurationInput, unitsInput, startUnitInput, activityStartDateInput;
    let projectStartDateInput;
    let dependencyLinksContainer, addDependencyBtn;
    let saveProjectBtn, loadProjectBtn, resetProjectBtn, exportJsonBtn, importJsonBtn, exportCsvBtn, exportPdfBtn; // Added JSON buttons
    let jsonFileInput; // For hidden file input
    let loadProjectModal, savedProjectsSelect, confirmLoadProjectBtn, cancelLoadProjectBtn, deleteSavedProjectBtn;
    const LOB_PROJECT_INDEX_KEY = 'lobProjectIndex_v2';
    const LOB_PROJECT_PREFIX = 'lobProjectData_v2_';
    function generateId() { return '_' + Math.random().toString(36).substr(2, 9); }
    function getNextColor() { const color = colors[colorIndex % colors.length]; colorIndex++; return color; }
    function getActivityById(id) { return activities.find(act => act.id === id); }
    function naturalSortActivities(a, b) { const aCode = a.wbsCode || ""; const bCode = b.wbsCode || ""; const ax = [], bx = []; aCode.replace(/(\d+)|(\D+)/g, (_, $1, $2) => { ax.push([$1 ? parseInt($1) : Infinity, $2 || ""]) }); bCode.replace(/(\d+)|(\D+)/g, (_, $1, $2) => { bx.push([$1 ? parseInt($1) : Infinity, $2 || ""]) }); while (ax.length && bx.length) { const an = ax.shift(); const bn = bx.shift(); const nn = (an[0] - bn[0]) || an[1].localeCompare(bn[1]); if (nn) return nn; } return ax.length - bx.length; }
    function addDays(date, days) { if (!date || !(date instanceof Date) || isNaN(date) || typeof days !== 'number' || isNaN(days)) { return null; } let result = new Date(date.getFullYear(), date.getMonth(), date.getDate()); result.setUTCDate(result.getUTCDate() + days); return result; }
    function formatDate(date) { if (!date || !(date instanceof Date) || isNaN(date)) return 'N/A'; try { const year = date.getUTCFullYear(); const month = date.getUTCMonth(); const day = date.getUTCDate(); return new Date(Date.UTC(year, month, day)).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC' }); } catch (e) { console.error("Error formatting date:", e, "Input date:", date); return 'Invalid Date'; } }
    function diffDays(date1, date2) { if (!date1 || !date2 || !(date1 instanceof Date) || !(date2 instanceof Date) || isNaN(date1) || isNaN(date2)) { return NaN; } const msPerDay = 1000 * 60 * 60 * 24; const utc1 = Date.UTC(date1.getUTCFullYear(), date1.getUTCMonth(), date1.getUTCDate()); const utc2 = Date.UTC(date2.getUTCFullYear(), date2.getUTCMonth(), date2.getUTCDate()); return Math.floor((utc2 - utc1) / msPerDay); }
    function showGlobalMessage(message, type = 'info') { const messageArea = document.getElementById('global-message-area'); if (messageArea) { messageArea.textContent = message; messageArea.className = 'p-3 mb-4 text-sm rounded-lg'; messageArea.classList.remove('success', 'error', 'info'); messageArea.classList.add(type); switch (type) { case 'success': messageArea.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-200'); break; case 'error': messageArea.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200'); break; case 'info': default: messageArea.classList.add('bg-blue-100', 'text-blue-700', 'border', 'border-blue-200'); break; } messageArea.style.display = 'block'; messageArea.setAttribute('role', 'alert'); setTimeout(() => { if (messageArea.textContent === message) { messageArea.style.display = 'none'; } }, 7000); } else { console.warn("Global message area not found. Message:", message); alert(`${type.toUpperCase()}: ${message}`); } }
    function recalculateSchedule() { console.log("Recalculating schedule..."); let summary = { projectStart: projectStartDate ? new Date(projectStartDate) : null, projectEnd: projectStartDate ? new Date(projectStartDate) : null, projectDuration: 0 }; try { if (!projectStartDate || isNaN(projectStartDate)) { showGlobalMessage("Invalid Project Start Date. Please set a valid date.", "error"); throw new Error("Invalid Project Start Date."); } if (activities.length === 0) { summary = { projectStart: new Date(projectStartDate), projectEnd: new Date(projectStartDate), projectDuration: 0 }; return summary; } activities.forEach(act => { act.relativeStartTime = null; act.relativeEndTime = null; act.actualStartDate = null; act.actualEndDate = null; act.calculated = false; }); let changedInIteration = true; let iterations = 0; const maxIterations = activities.length * activities.length + activities.length + 10; while (changedInIteration && iterations < maxIterations) { changedInIteration = false; iterations++; activities.forEach(activity => { if (activity.calculated || activity.relativeStartTime === 'error') return; let requiredStartDay = 0; let allPredsCalculatedOrError = true; let predecessorError = false; const overallDuration = parseFloat(activity.overallDuration); if (isNaN(overallDuration) || overallDuration <= 0 || (parseInt(activity.numUnits) || 0) <= 0) { activity.relativeStartTime = 'error'; activity.relativeEndTime = 'error'; activity.calculated = true; changedInIteration = true; return; } if (activity.dependencies && activity.dependencies.length > 0) { for (const dep of activity.dependencies) { const predActivity = getActivityById(dep.predId); if (!predActivity) { console.warn(`Predecessor ID ${dep.predId} not found for activity ${activity.name}`); predecessorError = true; break; } if (predActivity.relativeStartTime === 'error') { predecessorError = true; break; } if (predActivity.relativeStartTime === null || predActivity.relativeEndTime === null) { allPredsCalculatedOrError = false; break; } let constraintStartDay = 0; const lag = parseFloat(dep.lag) || 0; switch (dep.type) { case 'FS': constraintStartDay = predActivity.relativeEndTime + lag; break; case 'SS': constraintStartDay = predActivity.relativeStartTime + lag; break; case 'FF': constraintStartDay = predActivity.relativeEndTime + lag - overallDuration; break; case 'SF': constraintStartDay = predActivity.relativeStartTime + lag - overallDuration; break; default: constraintStartDay = predActivity.relativeEndTime + lag; } requiredStartDay = Math.max(requiredStartDay, constraintStartDay); } } if (predecessorError) { activity.relativeStartTime = 'error'; activity.relativeEndTime = 'error'; activity.calculated = true; changedInIteration = true; return; } if (!allPredsCalculatedOrError) { activity.calculated = false; return; } let computedStartTime = requiredStartDay; if (activity.manualStartDate && !isNaN(activity.manualStartDate)) { const manualStartDay = diffDays(projectStartDate, activity.manualStartDate); if(!isNaN(manualStartDay)) computedStartTime = Math.max(computedStartTime, manualStartDay); } const newRelativeStartTime = computedStartTime; const newRelativeEndTime = newRelativeStartTime + overallDuration; if (activity.relativeStartTime !== newRelativeStartTime || activity.relativeEndTime !== newRelativeEndTime) { activity.relativeStartTime = newRelativeStartTime; activity.relativeEndTime = newRelativeEndTime; changedInIteration = true; } activity.calculated = true; }); } if (iterations >= maxIterations && activities.some(a => !a.calculated && a.relativeStartTime !== 'error')) { console.error("Max iterations reached. Possible cyclic dependency or unresolvable logic."); showGlobalMessage("Calculation Error: Cyclic dependencies or unresolvable links suspected. Review activity dependencies.", "error"); activities.forEach(act => { if (!act.calculated) { act.relativeStartTime = 'error'; act.relativeEndTime = 'error'; } }); } let overallProjectActualStart = null; let overallProjectActualEnd = null; let hasValidActivityDates = false; activities.forEach(act => { if (typeof act.relativeStartTime === 'number' && act.relativeStartTime !== 'error') { act.actualStartDate = addDays(projectStartDate, act.relativeStartTime); if (act.actualStartDate && (!overallProjectActualStart || act.actualStartDate < overallProjectActualStart)) { overallProjectActualStart = act.actualStartDate; } hasValidActivityDates = true; } else { act.actualStartDate = null; } if (typeof act.relativeEndTime === 'number' && act.relativeEndTime !== 'error') { act.actualEndDate = addDays(projectStartDate, act.relativeEndTime); if (act.actualEndDate && (!overallProjectActualEnd || act.actualEndDate > overallProjectActualEnd)) { overallProjectActualEnd = act.actualEndDate; } hasValidActivityDates = true; } else { act.actualEndDate = null; } }); if (!hasValidActivityDates && activities.length > 0) { overallProjectActualStart = new Date(projectStartDate); overallProjectActualEnd = new Date(projectStartDate); summary.projectDuration = 'Error'; } else if (activities.length === 0) { overallProjectActualStart = new Date(projectStartDate); overallProjectActualEnd = new Date(projectStartDate); summary.projectDuration = 0; } else { overallProjectActualStart = overallProjectActualStart || new Date(projectStartDate); overallProjectActualEnd = overallProjectActualEnd || new Date(projectStartDate); const durationInDays = diffDays(overallProjectActualStart, overallProjectActualEnd); summary.projectDuration = isNaN(durationInDays) ? 'Error' : durationInDays; } summary.projectStart = overallProjectActualStart; summary.projectEnd = overallProjectActualEnd; } catch (error) { console.error("Error in recalculateSchedule:", error); showGlobalMessage(`Error during schedule calculation: ${error.message}. Check console.`, "error"); summary = { projectStart: new Date(projectStartDate), projectEnd: new Date(projectStartDate), projectDuration: 'Error' }; activities.forEach(act => { act.relativeStartTime = 'error'; act.relativeEndTime = 'error'; act.actualStartDate = null; act.actualEndDate = null; }); } console.log("Schedule calculation finished. Summary:", summary, "Activities:", JSON.parse(JSON.stringify(activities))); return summary; }
    
    function updateLobChart(projectStart, projectEnd) {
        const validActivities = activities.filter(act => act.actualStartDate && act.actualEndDate && !isNaN(act.numUnits) && act.numUnits > 0 && act.relativeStartTime !== 'error');
        const lobDatasets = validActivities.map(act => {
            const startPoint = { x: act.actualStartDate, y: act.startUnit };
            const endPoint = { x: act.actualEndDate, y: act.startUnit + act.numUnits };
            return { label: `${act.wbsCode} - ${act.name}`, data: [startPoint, endPoint], borderColor: act.color, backgroundColor: act.color, fill: false, tension: 0, borderWidth: 2, pointRadius: 3 };
        });
        const displayProjectEnd = projectEnd ? addDays(new Date(projectEnd), 1) : undefined; 

        const lobData = { datasets: lobDatasets };
        const lobConfig = {
            type: 'line', data: lobData,
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', min: projectStart ? projectStart.toISOString().split('T')[0] : undefined, max: displayProjectEnd ? displayProjectEnd.toISOString().split('T')[0] : undefined, time: { unit: 'day', round: 'day', tooltipFormat: 'MMM d, yyyy' }, title: { display: true, text: 'Date', font: { family: 'var(--font-main)' } }, ticks: { font: { family: 'var(--font-main)' } } },
                    y: { beginAtZero: true, ticks: { stepSize: 1, font: { family: 'var(--font-main)' } }, title: { display: true, text: 'Units', font: { family: 'var(--font-main)' } } }
                },
                plugins: { legend: { display: true, position: 'top', labels: { font: { family: 'var(--font-main)' } } }, tooltip: { bodyFont: { family: 'var(--font-main)' }, titleFont: { family: 'var(--font-main)' } } }
            }
        };
        if (lobChartInstance) lobChartInstance.destroy();
        if (document.getElementById("lob-chart")) { lobChartInstance = new Chart(document.getElementById("lob-chart"), lobConfig); }
    }

    function updateGanttChart(projectStart, projectEnd) {
        const validActivitiesForGantt = activities.filter(act => act.actualStartDate && act.actualEndDate && act.relativeStartTime !== 'error');
        const labels = validActivitiesForGantt.map(act => act.wbsCode + " - " + act.name);
        const data = validActivitiesForGantt.map(act => [act.actualStartDate, act.actualEndDate]);
        const displayProjectEndGantt = projectEnd ? addDays(new Date(projectEnd), 1) : undefined;

        const ganttData = {
            labels: labels,
            datasets: [{ label: 'Activity Duration', data: data, backgroundColor: validActivitiesForGantt.map(act => act.color), borderColor: validActivitiesForGantt.map(act => act.color), borderWidth: 1, borderSkipped: false, borderRadius: 4, barPercentage: 0.6, categoryPercentage: 0.7 }]
        };
        const ganttConfig = {
            type: "bar", data: ganttData,
            options: {
                responsive: true, indexAxis: "y", maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', min: projectStart ? projectStart.toISOString().split('T')[0] : undefined, max: displayProjectEndGantt ? displayProjectEndGantt.toISOString().split('T')[0] : undefined, time: { unit: 'day', tooltipFormat: 'MMM d, yyyy' }, title: { display: true, text: "Timeline", font: { family: 'var(--font-main)' } }, ticks: { font: { family: 'var(--font-main)' } } },
                    y: { ticks: { font: { family: 'var(--font-main)' } } }
                },
                layout: { padding: { left: 10, right: 10, top: 5, bottom: 5 } },
                plugins: {
                    legend: { display: false },
                    tooltip: { bodyFont: { family: 'var(--font-main)' }, titleFont: { family: 'var(--font-main)' }, callbacks: { label: function (context) { const act = validActivitiesForGantt[context.dataIndex]; if (!act) return ''; const startDate = formatDate(act.actualStartDate); const endDate = formatDate(act.actualEndDate); return `${act.name}: ${startDate} - ${endDate} (${act.overallDuration} days)`; } } }
                }
            }
        };
        if (ganttChartInstance) ganttChartInstance.destroy();
        if (document.getElementById("gantt-chart")) { ganttChartInstance = new Chart(document.getElementById("gantt-chart"), ganttConfig); }
    }

    function displayProjectInfo(summary) { if (projectStartDateEl && projectEndDateEl && projectDurationEl) { projectStartDateEl.textContent = summary && summary.projectStart ? formatDate(summary.projectStart) : "-"; projectEndDateEl.textContent = summary && summary.projectEnd ? formatDate(summary.projectEnd) : "-"; projectDurationEl.textContent = (summary && (summary.projectDuration === 'Error' || summary.projectDuration === undefined)) ? 'Error' : (summary ? summary.projectDuration : '-'); } }
    function buildWbsTree(activitiesToBuild) { let root = { children: {} }; const sortedActivities = [...activitiesToBuild].sort(naturalSortActivities); sortedActivities.forEach(activity => { let parts = activity.wbsCode.split("."); let node = root; let currentPath = ""; parts.forEach((part, index) => { currentPath += (index > 0 ? "." : "") + part; if (!node.children[part]) { node.children[part] = { id: currentPath, children: {} }; } node = node.children[part]; }); node.activity = activity; }); return root; }
    
    function renderWbsTree(node, level = 0) {
      let ul = document.createElement("ul");
      if (level > 0) ul.className = "ml-4 pl-4 border-l border-gray-300"; 
      const sortedKeys = Object.keys(node.children).sort((a, b) => { const numA = parseFloat(a); const numB = parseFloat(b); if (!isNaN(numA) && !isNaN(numB)) return numA - numB; return a.localeCompare(b); });
      for (const key of sortedKeys) {
        let childNode = node.children[key];
        let li = document.createElement("li");
        li.className = "relative mb-1"; 
        li.setAttribute('role', 'treeitem');
        if (childNode.activity) {
          let act = childNode.activity;
          let card = document.createElement("div");
          card.className = "bg-white shadow-sm p-2 rounded-md flex justify-between items-center mb-2"; 
          card.setAttribute('aria-expanded', 'false');
          if (act.color) { card.style.borderLeftColor = act.color; } else { card.style.borderLeftColor = 'var(--border-color-light)'; }
          let leftSection = document.createElement("div");
          leftSection.className = "flex items-start space-x-2"; 
          // let colorIndicator = document.createElement("div"); 
          // colorIndicator.className = "w-3 h-3 rounded-full mt-1 flex-shrink-0"; 
          // colorIndicator.style.backgroundColor = act.color || '#ccc';
          // leftSection.appendChild(colorIndicator); 
          let info = document.createElement("div");
          info.className = "text-xs"; 
          const rate = (act.overallDuration > 0 && act.numUnits > 0) ? (act.numUnits / act.overallDuration).toFixed(2) : "N/A";
          let errorStyle = (act.relativeStartTime === 'error' || act.relativeEndTime === 'error') ? 'color: var(--accent-danger); font-weight: bold;' : '';
          info.innerHTML = ` <strong style="${errorStyle}">${act.wbsCode}</strong> â€“ ${act.name}<br> <span style="${errorStyle}"> ${act.actualStartDate ? formatDate(act.actualStartDate) : "N/A"} to ${act.actualEndDate ? formatDate(act.actualEndDate) : "N/A"} </span><br> <span>Dur: ${act.overallDuration}, Units: ${act.numUnits}, Prod: ${rate} u/day</span> `;
          if (act.relativeStartTime === 'error') { info.innerHTML += `<br><span style="color: var(--accent-danger); font-style: italic;">Scheduling error.</span>`; }
          leftSection.appendChild(info); card.appendChild(leftSection);
          let rightSection = document.createElement("div"); rightSection.className = "flex space-x-1 flex-shrink-0";
          let editBtn = document.createElement("button"); editBtn.className = "edit-btn control-btn"; editBtn.innerHTML = `<i class="fas fa-edit" aria-hidden="true"></i> Edit`; editBtn.setAttribute('aria-label', `Edit activity ${act.name}`); editBtn.addEventListener("click", (e) => { e.stopPropagation(); startEditActivity(act.id); });
          let delBtn = document.createElement("button"); delBtn.className = "delete-btn control-btn"; delBtn.innerHTML = `<i class="fas fa-trash-alt" aria-hidden="true"></i> Del`; delBtn.setAttribute('aria-label', `Delete activity ${act.name}`); delBtn.addEventListener("click", (e) => { e.stopPropagation(); if(confirm(`Are you sure you want to delete "${act.name}"?`)) deleteActivity(act.id); });
          rightSection.appendChild(editBtn); rightSection.appendChild(delBtn); card.appendChild(rightSection); li.appendChild(card);
        } else { let summaryNodeLabel = document.createElement("div"); summaryNodeLabel.className = "text-sm font-medium text-gray-600 py-1"; summaryNodeLabel.textContent = `WBS ${childNode.id}`; li.appendChild(summaryNodeLabel); }
        if (Object.keys(childNode.children).length > 0) { li.setAttribute('aria-expanded', 'true'); li.appendChild(renderWbsTree(childNode, level + 1)); }
        ul.appendChild(li);
      }
      return ul;
    }

    function renderActivityList() { if (!activityListContainer || !noActivitiesMessage) return; if (activities.length === 0) { noActivitiesMessage.style.display = "block"; activityListContainer.style.display = "none"; activityListContainer.innerHTML = ""; return; } noActivitiesMessage.style.display = "none"; activityListContainer.style.display = "block"; activityListContainer.innerHTML = ""; const tree = buildWbsTree(activities); const treeList = renderWbsTree(tree); activityListContainer.appendChild(treeList); }
    function startEditActivity(id) { console.log("Editing activity:", id); const act = getActivityById(id); if (!act) return; editingActivityId = id; wbsCodeInput.value = act.wbsCode; nameInput.value = act.name; overallDurationInput.value = act.overallDuration; unitsInput.value = act.numUnits; startUnitInput.value = act.startUnit; if (act.manualStartDate && act.manualStartDate instanceof Date && !isNaN(act.manualStartDate)) { const offset = act.manualStartDate.getTimezoneOffset(); const localDate = new Date(act.manualStartDate.getTime() - offset * 60 * 1000); activityStartDateInput.value = localDate.toISOString().split("T")[0]; } else { activityStartDateInput.value = ""; } dependencyLinksContainer.innerHTML = ""; if (act.dependencies && act.dependencies.length > 0) { act.dependencies.forEach(dep => { addDependencyRow(dep.predId, dep.type, dep.lag); }); } document.getElementById("activity-form-heading").textContent = "Edit Activity"; submitButton.innerHTML = `<i class="fas fa-save"></i> Update Activity`; cancelEditButton.style.display = "block"; wbsCodeInput.focus(); }
    function deleteActivity(id) { console.log("Deleting activity:", id); const activityToDelete = getActivityById(id); if (!activityToDelete) return; activities = activities.filter(a => a.id !== id); activities.forEach(act => { if (act.dependencies) { act.dependencies = act.dependencies.filter(dep => dep.predId !== id); } }); updateUI(); showGlobalMessage(`Activity "${activityToDelete.name}" deleted.`, "info"); }
    function cancelEdit() { form.reset(); dependencyLinksContainer.innerHTML = ""; editingActivityId = null; document.getElementById("activity-form-heading").textContent = "Add/Edit Activity"; submitButton.innerHTML = `<i class="fas fa-check-circle"></i> Add Activity`; cancelEditButton.style.display = "none"; }
    function handleFormSubmit(event) { event.preventDefault(); const wbsCodeVal = wbsCodeInput.value.trim(); const nameVal = nameInput.value.trim(); const durationVal = parseFloat(overallDurationInput.value); const manualDateString = activityStartDateInput.value; const manualDateVal = manualDateString ? new Date(manualDateString + "T00:00:00Z") : null; const unitsVal = parseInt(unitsInput.value); const sUnitVal = parseInt(startUnitInput.value); if (!wbsCodeVal || !nameVal || isNaN(durationVal) || durationVal <= 0 || isNaN(unitsVal) || unitsVal <= 0 || isNaN(sUnitVal) || sUnitVal <= 0) { showGlobalMessage("Error: Fill required fields with valid numbers (Duration, Units, Start Unit > 0).", "error"); return; } if (!/^[0-9]+(\.[0-9]+)*$/.test(wbsCodeVal)) { showGlobalMessage("Error: Invalid WBS Code format. Use numbers and dots (e.g., 1.1.2).", "error"); return; } if (manualDateVal && isNaN(manualDateVal.getTime())) { showGlobalMessage("Error: Invalid Manual Start Date.", "error"); return; } const isWbsDuplicate = activities.some(act => act.wbsCode === wbsCodeVal && act.id !== editingActivityId); if (isWbsDuplicate) { showGlobalMessage("Error: WBS code must be unique.", "error"); return; } const newDependencies = []; const rows = dependencyLinksContainer.querySelectorAll(".dependency-row"); let depError = false; rows.forEach(row => { const predSelect = row.querySelector(".pred-activity-select"); const typeSelect = row.querySelector(".dependency-type-select"); const lagInput = row.querySelector(".dependency-lag-input"); if (predSelect && predSelect.value && typeSelect && lagInput) { if (editingActivityId && predSelect.value === editingActivityId) { showGlobalMessage("Error: An activity cannot depend on itself.", "error"); depError = true; return; } newDependencies.push({ predId: predSelect.value, type: typeSelect.value, lag: parseFloat(lagInput.value) || 0 }); } }); if (depError) return; if (editingActivityId) { const existing = getActivityById(editingActivityId); if (existing) { existing.wbsCode = wbsCodeVal; existing.name = nameVal; existing.overallDuration = durationVal; existing.manualStartDate = manualDateVal; existing.numUnits = unitsVal; existing.startUnit = sUnitVal; existing.dependencies = newDependencies; showGlobalMessage(`Activity "${existing.name}" updated.`, "success"); } } else { const newActivity = { id: generateId(), wbsCode: wbsCodeVal, name: nameVal, overallDuration: durationVal, manualStartDate: manualDateVal, numUnits: unitsVal, startUnit: sUnitVal, dependencies: newDependencies, color: getNextColor() }; activities.push(newActivity); showGlobalMessage(`Activity "${newActivity.name}" added.`, "success"); } cancelEdit(); updateUI(); }
    function addDependencyRow(selectedPredId = "", selectedType = "FS", lagValue = 0) { const row = document.createElement("div"); row.className = "dependency-row"; row.innerHTML = ` <select class="pred-activity-select text-sm border rounded-md" aria-label="Predecessor Activity"> <option value="">-- Predecessor --</option> ${activities.filter(act => !editingActivityId || act.id !== editingActivityId) .sort(naturalSortActivities) .map(act => `<option value="${act.id}" ${act.id === selectedPredId ? "selected" : ""}>${act.wbsCode} - ${act.name}</option>`).join("")} </select> <select class="dependency-type-select text-sm border rounded-md" aria-label="Dependency Type"> <option value="FS" ${selectedType==="FS"?"selected":""}>FS</option> <option value="SS" ${selectedType==="SS"?"selected":""}>SS</option> <option value="FF" ${selectedType==="FF"?"selected":""}>FF</option> <option value="SF" ${selectedType==="SF"?"selected":""}>SF</option> </select> <div class="floating-input" style="overflow: visible; z-index: 1;"> <input type="number" class="dependency-lag-input" placeholder=" " step="0.1" value="${lagValue}" aria-label="Lag in days"/> <label>Lag</label> </div> <button type="button" class="remove-dependency-btn text-lg" onclick="this.closest('.dependency-row').remove()" aria-label="Remove this dependency">Ã—</button> `; dependencyLinksContainer.appendChild(row); }
    function updateUI() { console.log("--- Starting updateUI ---"); try { if (!projectStartDate || isNaN(projectStartDate)) { showGlobalMessage("Invalid Project Start Date. Please set a valid date.", "error"); console.error("Invalid Project Start Date during updateUI."); return; } const projectSummary = recalculateSchedule(); displayProjectInfo(projectSummary); if (activities.length === 0) { renderActivityList(); if (lobChartInstance && typeof lobChartInstance.destroy === 'function') lobChartInstance.destroy(); if (ganttChartInstance && typeof ganttChartInstance.destroy === 'function') ganttChartInstance.destroy(); if(document.getElementById("lob-chart")) lobChartInstance = new Chart(document.getElementById("lob-chart"), {type:'line', data:{datasets:[]}, options:{responsive:true, maintainAspectRatio:false, animation: false}}); if(document.getElementById("gantt-chart")) ganttChartInstance = new Chart(document.getElementById("gantt-chart"), {type:'bar', data:{labels:[], datasets:[]}, options:{responsive:true, maintainAspectRatio:false, animation: false}}); } else if (projectSummary && projectSummary.projectStart !== null) { renderActivityList(); updateLobChart(projectSummary.projectStart, projectSummary.projectEnd); updateGanttChart(projectSummary.projectStart, projectSummary.projectEnd); } else { console.warn("Schedule calculation might be incomplete or in an error state if summary is null but activities exist."); renderActivityList(); } console.log("--- UI update complete ---"); } catch (error) { console.error("Error during updateUI:", error); showGlobalMessage(`An error occurred updating the display: ${error.message}. Check console.`, "error"); } }
    function saveProjectToLocalStorage() { const currentProjectName = document.title.replace('LOB Scheduler - ','').trim(); let projectName = prompt("Enter a name for this project:", currentProjectName !== 'LOB Scheduler' ? currentProjectName : `Project ${formatDate(new Date())}`); if (!projectName || projectName.trim() === "") { showGlobalMessage("Save cancelled or project name not provided.", "info"); return; } projectName = projectName.trim(); try { const projectData = { projectName: projectName, projectStartDate: projectStartDateInput.value, activities: activities.map(act => ({ ...act, actualStartDate: null, actualEndDate: null, calculated: false, relativeStartTime: null, relativeEndTime: null })) }; let projectIndex = JSON.parse(localStorage.getItem(LOB_PROJECT_INDEX_KEY) || '[]'); if (!projectIndex.includes(projectName)) { projectIndex.push(projectName); localStorage.setItem(LOB_PROJECT_INDEX_KEY, JSON.stringify(projectIndex)); } localStorage.setItem(LOB_PROJECT_PREFIX + projectName, JSON.stringify(projectData)); document.title = `LOB Scheduler - ${projectName}`; showGlobalMessage(`Project "${projectName}" saved successfully!`, 'success'); } catch (e) { console.error("Error saving to localStorage:", e); showGlobalMessage('Error saving project. Local storage might be full or disabled.', 'error'); } }
    function loadSpecificProject(projectName) { try { const savedData = localStorage.getItem(LOB_PROJECT_PREFIX + projectName); if (savedData) { const projectData = JSON.parse(savedData); projectStartDateInput.value = projectData.projectStartDate; projectStartDate = new Date(projectData.projectStartDate + "T00:00:00Z"); activities = projectData.activities || []; colorIndex = 0; activities.forEach(act => { act.color = getNextColor(); if (act.manualStartDate) act.manualStartDate = new Date(act.manualStartDate); }); updateUI(); cancelEdit(); document.title = `LOB Scheduler - ${projectName}`; showGlobalMessage(`Project "${projectName}" loaded successfully!`, 'success'); } else { showGlobalMessage(`Could not find project "${projectName}".`, 'error'); } } catch (e) { console.error("Error loading from localStorage:", e); showGlobalMessage('Error loading project. Saved data might be corrupted.', 'error'); } }
    function deleteSpecificProject(projectName) { try { localStorage.removeItem(LOB_PROJECT_PREFIX + projectName); let projectIndex = JSON.parse(localStorage.getItem(LOB_PROJECT_INDEX_KEY) || '[]'); projectIndex = projectIndex.filter(name => name !== projectName); localStorage.setItem(LOB_PROJECT_INDEX_KEY, JSON.stringify(projectIndex)); showGlobalMessage(`Project "${projectName}" deleted.`, 'info'); if (document.title === `LOB Scheduler - ${projectName}`) { document.title = 'Line of Balance (LOB) Scheduler & Analyzer'; } } catch (e) { console.error("Error deleting project:", e); showGlobalMessage('Error deleting project.', 'error'); } }
    function populateSavedProjectsSelect() { savedProjectsSelect.innerHTML = '<option value="">-- Select a Project --</option>'; const projectIndex = JSON.parse(localStorage.getItem(LOB_PROJECT_INDEX_KEY) || '[]'); projectIndex.sort(); projectIndex.forEach(name => { const option = document.createElement('option'); option.value = name; option.textContent = name; savedProjectsSelect.appendChild(option); }); }
    function loadProjectFromLocalStorage() { const lastProjectName = localStorage.getItem('lobLastOpenedProject'); const projectIndex = JSON.parse(localStorage.getItem(LOB_PROJECT_INDEX_KEY) || '[]'); if (lastProjectName && projectIndex.includes(lastProjectName)) { loadSpecificProject(lastProjectName); } else if (projectIndex.length > 0) { console.log("No last opened project, or it's no longer available. User can select from Load Project modal."); } else { console.log("No saved projects found."); updateUI(); } }
    
    function resetProject() {
        if (confirm("Are you sure you want to reset the project? All current activities and data will be cleared.")) {
            activities = [];
            editingActivityId = null;
            colorIndex = 0;
            if (form) form.reset(); 
            if (dependencyLinksContainer) dependencyLinksContainer.innerHTML = ""; 
            
            const today = new Date();
            const offset = today.getTimezoneOffset();
            const todayLocal = new Date(today.getTime() - (offset * 60 * 1000));
            if (projectStartDateInput) projectStartDateInput.value = todayLocal.toISOString().split("T")[0];
            projectStartDate = new Date(projectStartDateInput.value + "T00:00:00Z");

            document.title = 'Line of Balance (LOB) Scheduler & Analyzer'; 
            localStorage.removeItem('lobLastOpenedProject'); 

            updateUI(); 
            showGlobalMessage("Project has been reset.", "info");
        }
    }

    function exportProjectToJSON() {
       if (activities.length === 0 && !projectStartDateInput.value) {
           showGlobalMessage("Project is empty. Nothing to export.", "info");
           return;
       }
       const currentProjectNameBase = document.title.replace('LOB Scheduler - ','').replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'lob_project';
       const fileName = `${currentProjectNameBase}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.json`;
       try {
           const projectData = {
               projectName: document.title.includes("LOB Scheduler - ") ? document.title.split("LOB Scheduler - ")[1] : "Untitled LOB Project",
               projectStartDate: projectStartDateInput.value,
               activities: activities.map(act => {
                   const { actualStartDate, actualEndDate, calculated, relativeStartTime, relativeEndTime, ...cleanAct } = act;
                   if (cleanAct.manualStartDate instanceof Date) {
                       const offset = cleanAct.manualStartDate.getTimezoneOffset();
                       const localDate = new Date(cleanAct.manualStartDate.getTime() - offset * 60 * 1000);
                       cleanAct.manualStartDate = localDate.toISOString().split("T")[0];
                   }
                   return cleanAct;
               })
           };
           const jsonString = JSON.stringify(projectData, null, 2);
           const blob = new Blob([jsonString], { type: "application/json" });
           const link = document.createElement("a");
           link.href = URL.createObjectURL(blob);
           link.download = fileName;
           document.body.appendChild(link);
           link.click();
           document.body.removeChild(link);
           URL.revokeObjectURL(link.href);
           showGlobalMessage(`Project exported to ${fileName}`, "success");
       } catch (e) { console.error("Error exporting project to JSON:", e); showGlobalMessage('Error exporting project. See console for details.', 'error'); }
    }

    function handleJsonFileImport(event) {
        const file = event.target.files[0];
        if (!file) { return; }
        if (file.type !== "application/json") { showGlobalMessage("Invalid file type. Please select a JSON file.", "error"); event.target.value = null; return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const projectData = JSON.parse(e.target.result);
                if (!projectData || typeof projectData.projectStartDate === 'undefined' || !Array.isArray(projectData.activities)) { throw new Error("Invalid JSON structure for project data."); }
                if (confirm("Importing this project will overwrite any unsaved changes in the current project. Continue?")) {
                    projectStartDateInput.value = projectData.projectStartDate;
                    projectStartDate = new Date(projectData.projectStartDate + "T00:00:00Z");
                    activities = projectData.activities.map(actFromFile => {
                        const newAct = { ...actFromFile };
                        if (newAct.manualStartDate && typeof newAct.manualStartDate === 'string') {
                            newAct.manualStartDate = new Date(newAct.manualStartDate + "T00:00:00Z");
                            if (isNaN(newAct.manualStartDate.getTime())) newAct.manualStartDate = null;
                        } else if (!(newAct.manualStartDate instanceof Date)) { newAct.manualStartDate = null; }
                        if (!newAct.id) newAct.id = generateId();
                        if (!newAct.color) newAct.color = getNextColor();
                        return newAct;
                    });
                    colorIndex = activities.length; 
                    editingActivityId = null;
                    document.title = projectData.projectName ? `LOB Scheduler - ${projectData.projectName}` : 'Line of Balance (LOB) Scheduler & Analyzer';
                    localStorage.setItem('lobLastOpenedProject', projectData.projectName || '');
                    updateUI();
                    cancelEdit(); 
                    showGlobalMessage(`Project "${projectData.projectName || 'Untitled Project'}" imported successfully!`, "success");
                }
            } catch (error) { console.error("Error importing JSON file:", error); showGlobalMessage(`Error importing project: ${error.message}. Check console.`, "error");
            } finally { event.target.value = null; }
        };
        reader.onerror = function() { showGlobalMessage("Error reading the JSON file.", "error"); event.target.value = null; };
        reader.readAsText(file);
    }

    function exportActivitiesToCSV() { if (activities.length === 0) { showGlobalMessage("No activities to export.", "info"); return; } let csvContent = "data:text/csv;charset=utf-8,"; csvContent += "WBS Code,Activity Name,Overall Duration,Manual Start Date,No. of Units,Start Unit,Actual Start Date,Actual End Date,Predecessors (PredWBS:Type:Lag)\r\n"; activities.sort(naturalSortActivities).forEach(act => { const manualStart = act.manualStartDate ? formatDate(new Date(act.manualStartDate)) : ""; const actualStart = act.actualStartDate ? formatDate(new Date(act.actualStartDate)) : "N/A"; const actualEnd = act.actualEndDate ? formatDate(new Date(act.actualEndDate)) : "N/A"; const dependenciesString = (act.dependencies || []) .map(dep => { const predAct = getActivityById(dep.predId); return `${predAct ? predAct.wbsCode : dep.predId}:${dep.type}:${dep.lag}`; }) .join("; "); let row = [ `"${act.wbsCode}"`, `"${act.name}"`, act.overallDuration, `"${manualStart}"`, act.numUnits, act.startUnit, `"${actualStart}"`, `"${actualEnd}"`, `"${dependenciesString}"` ].join(","); csvContent += row + "\r\n"; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); const projectNameForFile = document.title.replace('LOB Scheduler - ','').replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'lob_activities'; link.setAttribute("download", `${projectNameForFile}_export.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); showGlobalMessage("Activities exported to CSV.", "success"); }
    
    async function generatePdfReport() {
        if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
            showGlobalMessage("PDF generation libraries not loaded. Please check console.", "error"); return;
        }
        showGlobalMessage("Generating PDF report... please wait.", "info");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
        const margin = 40; let currentY = margin;
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const contentWidth = pageWidth - 2 * margin;
        let pageNumber = 0; 

        const addFooters = () => {
            const pageCount = pdf.internal.getNumberOfPages();
            pdf.setFont("helvetica", "italic"); pdf.setFontSize(8);
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                const text = `Page ${i} of ${pageCount}`;
                const textWidth = pdf.getStringUnitWidth(text) * pdf.getFontSize() / pdf.internal.scaleFactor;
                pdf.text(text, pageWidth - margin - textWidth, pageHeight - margin / 2);
            }
        };
        
        const newPage = () => { pdf.addPage(); pageNumber++; currentY = margin; };

        pdf.setFont("helvetica", 'bold'); pdf.setFontSize(18);
        pdf.text("Line of Balance (LOB) Report", pageWidth / 2, currentY, { align: 'center' }); currentY += 30;
        pdf.setFont("helvetica", 'normal'); pdf.setFontSize(12);
        const currentProjectTitle = document.title.includes("LOB Scheduler - ") ? document.title.split("LOB Scheduler - ")[1] : "Untitled Project";
        pdf.text(`Project: ${currentProjectTitle}`, margin, currentY); currentY += 20;
        pdf.text(`Report Date: ${formatDate(new Date())}`, margin, currentY); currentY += 30;

        if (currentY + 60 > pageHeight - margin) newPage();
        pdf.setFont("helvetica", 'bold'); pdf.text("Project Summary:", margin, currentY); currentY += 20;
        pdf.setFont("helvetica", 'normal'); pdf.setFontSize(10);
        pdf.text(`Start Date: ${projectStartDateEl.textContent}`, margin, currentY);
        pdf.text(`End Date: ${projectEndDateEl.textContent}`, pageWidth / 2, currentY, { align: 'left' }); currentY += 15;
        pdf.text(`Duration: ${projectDurationEl.textContent} days`, margin, currentY); currentY += 30;

        if (activities.length > 0) {
            if (currentY + 60 > pageHeight - margin) newPage();
            pdf.setFont("helvetica", 'bold'); pdf.setFontSize(12);
            pdf.text("Activities Table:", margin, currentY); currentY += 25;

            const lineHeight = 15; const cellPadding = 3; 
            pdf.setFont("helvetica", "bold"); pdf.setFontSize(8);
            const colWidths = { wbs: 55, name: 140, deps: 90, duration: 40, units: 35, prod: 55, start: 65, end: 65 };
            
            function drawCell(text, x, y, width, isHeader = false) {
                pdf.setFont("helvetica", isHeader ? "bold" : "normal");
                const lines = pdf.splitTextToSize(String(text === null || text === undefined ? "" : text), width - (2 * cellPadding));
                pdf.text(lines, x + cellPadding, y + lineHeight - cellPadding * 1.5);
                return lines.length * (lineHeight * 0.75);
            }
            const drawRowLine = (yPos) => { pdf.setDrawColor(200); pdf.line(margin, yPos, pageWidth - margin, yPos); };
            
            let headerX = margin;
            drawCell("WBS", headerX, currentY, colWidths.wbs, true); headerX += colWidths.wbs;
            drawCell("Activity Name", headerX, currentY, colWidths.name, true); headerX += colWidths.name;
            drawCell("Dependencies", headerX, currentY, colWidths.deps, true); headerX += colWidths.deps;
            drawCell("Dur.", headerX, currentY, colWidths.duration, true); headerX += colWidths.duration;
            drawCell("Units", headerX, currentY, colWidths.units, true); headerX += colWidths.units;
            drawCell("Prod.", headerX, currentY, colWidths.prod, true); headerX += colWidths.prod;
            drawCell("Start", headerX, currentY, colWidths.start, true); headerX += colWidths.start;
            drawCell("End", headerX, currentY, colWidths.end, true);
            currentY += lineHeight; drawRowLine(currentY); currentY += cellPadding;
            pdf.setFont("helvetica", "normal"); pdf.setFontSize(7);

            activities.sort(naturalSortActivities).forEach(act => {
                let maxRowHeight = lineHeight * 0.75; 
                const rowData = [
                    { text: act.wbsCode, width: colWidths.wbs }, { text: act.name, width: colWidths.name },
                    { text: (act.dependencies || []).map(d => `${getActivityById(d.predId)?.wbsCode || '?'}${d.type ? ':'+d.type : ''}${d.lag ? ':'+d.lag : ''}`).join(', '), width: colWidths.deps },
                    { text: act.overallDuration, width: colWidths.duration }, { text: act.numUnits, width: colWidths.units },
                    { text: (act.overallDuration > 0 && act.numUnits > 0) ? (act.numUnits / act.overallDuration).toFixed(2) : "N/A", width: colWidths.prod },
                    { text: act.actualStartDate ? formatDate(new Date(act.actualStartDate)) : 'N/A', width: colWidths.start },
                    { text: act.actualEndDate ? formatDate(new Date(act.actualEndDate)) : 'N/A', width: colWidths.end }
                ];
                rowData.forEach(cell => { const lines = pdf.splitTextToSize(String(cell.text === null || cell.text === undefined ? "" : cell.text), cell.width - (2 * cellPadding)); maxRowHeight = Math.max(maxRowHeight, lines.length * (lineHeight * 0.75)); });
                maxRowHeight += cellPadding * 2; 
                if (currentY + maxRowHeight > pageHeight - margin - 20) { 
                    newPage(); headerX = margin;
                    pdf.setFont("helvetica", "bold"); pdf.setFontSize(8);
                    drawCell("WBS", headerX, currentY, colWidths.wbs, true); headerX += colWidths.wbs; drawCell("Activity Name", headerX, currentY, colWidths.name, true); headerX += colWidths.name; drawCell("Dependencies", headerX, currentY, colWidths.deps, true); headerX += colWidths.deps; drawCell("Dur.", headerX, currentY, colWidths.duration, true); headerX += colWidths.duration; drawCell("Units", headerX, currentY, colWidths.units, true); headerX += colWidths.units; drawCell("Prod.", headerX, currentY, colWidths.prod, true); headerX += colWidths.prod; drawCell("Start", headerX, currentY, colWidths.start, true); headerX += colWidths.start; drawCell("End", headerX, currentY, colWidths.end, true);
                    currentY += lineHeight; drawRowLine(currentY); currentY += cellPadding;
                    pdf.setFont("helvetica", "normal"); pdf.setFontSize(7);
                }
                let currentX = margin;
                rowData.forEach(cell => { drawCell(cell.text, currentX, currentY, cell.width); currentX += cell.width; });
                currentY += maxRowHeight - cellPadding; drawRowLine(currentY); currentY += cellPadding;
            });
            currentY += 15;
        }

        async function addChartToPdfOnNewPage(canvasId, chartTitle) {
            if (currentY > margin || pageNumber === 0 ) { newPage(); } else { currentY = margin; } // Ensure starts at top if already new
            const chartCanvas = document.getElementById(canvasId);
            if (chartCanvas) {
                pdf.setFont("helvetica", 'bold'); pdf.setFontSize(14);
                pdf.text(chartTitle, margin, currentY); currentY += 25;
                try {
                    const chartImage = await html2canvas(chartCanvas, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
                    const imgData = chartImage.toDataURL('image/png');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfChartWidth = contentWidth;
                    const pdfChartHeight = (imgProps.height * pdfChartWidth) / imgProps.width;
                    if (currentY + pdfChartHeight > pageHeight - margin - 20) { newPage(); pdf.setFont("helvetica", 'bold'); pdf.setFontSize(14); pdf.text(chartTitle, margin, currentY); currentY += 25;}
                    pdf.addImage(imgData, 'PNG', margin, currentY, pdfChartWidth, pdfChartHeight); currentY += pdfChartHeight + 20;
                } catch (e) { console.error(`Error capturing ${chartTitle}:`, e); if (currentY + 20 > pageHeight - margin) newPage(); pdf.setFont("helvetica", 'normal'); pdf.setTextColor(255, 0, 0); pdf.text(`Error rendering ${chartTitle}.`, margin, currentY); currentY += 20; pdf.setTextColor(0, 0, 0); }
            }
        }
        await addChartToPdfOnNewPage('lob-chart', "Line of Balance Chart");
        await addChartToPdfOnNewPage('gantt-chart', "Gantt Chart");

        addFooters();
        pdf.save(`LOB_Report_${currentProjectTitle.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.pdf`);
        showGlobalMessage("PDF report generated successfully!", "success");
    }
    
    document.addEventListener("DOMContentLoaded", () => { console.log("DOM fully loaded. Initializing LOB application..."); form = document.getElementById("activity-form"); submitButton = document.getElementById("submit-button"); cancelEditButton = document.getElementById("cancel-edit-button"); noActivitiesMessage = document.getElementById("no-activities-message"); activityListContainer = document.getElementById("activity-list-container"); projectStartDateEl = document.getElementById("project-start-date"); projectEndDateEl = document.getElementById("project-end-date"); projectDurationEl = document.getElementById("project-duration"); const lobCanvasEl = document.getElementById("lob-chart"); const ganttCanvasEl = document.getElementById("gantt-chart"); wbsCodeInput = document.getElementById("wbs-code"); nameInput = document.getElementById("activity-name"); overallDurationInput = document.getElementById("overall-duration"); unitsInput = document.getElementById("num-units"); startUnitInput = document.getElementById("start-unit"); activityStartDateInput = document.getElementById("activity-start-date"); projectStartDateInput = document.getElementById("project-start-date-input"); dependencyLinksContainer = document.getElementById("dependency-links-container"); addDependencyBtn = document.getElementById("add-dependency-btn"); saveProjectBtn = document.getElementById("save-project-btn"); loadProjectBtn = document.getElementById("load-project-btn"); resetProjectBtn = document.getElementById("reset-project-btn"); exportJsonBtn = document.getElementById('export-json-btn'); importJsonBtn = document.getElementById('import-json-btn'); jsonFileInput = document.getElementById('json-file-input'); exportCsvBtn = document.getElementById("export-csv-btn"); exportPdfBtn = document.getElementById('export-pdf-btn'); loadProjectModal = document.getElementById('loadProjectModal'); savedProjectsSelect = document.getElementById('savedProjectsSelect'); confirmLoadProjectBtn = document.getElementById('confirmLoadProject'); cancelLoadProjectBtn = document.getElementById('cancelLoadProject'); deleteSavedProjectBtn = document.getElementById('deleteSavedProject'); const criticalElements = { form, submitButton, cancelEditButton, noActivitiesMessage, activityListContainer, projectStartDateEl, projectEndDateEl, projectDurationEl, lobCanvasEl, ganttCanvasEl, wbsCodeInput, nameInput, overallDurationInput, unitsInput, startUnitInput, activityStartDateInput, projectStartDateInput, dependencyLinksContainer, addDependencyBtn, saveProjectBtn, loadProjectBtn, exportCsvBtn, loadProjectModal, savedProjectsSelect, confirmLoadProjectBtn, cancelLoadProjectBtn, deleteSavedProjectBtn, resetProjectBtn, exportJsonBtn, importJsonBtn, jsonFileInput }; for (const elName in criticalElements) { if (!criticalElements[elName]) { console.error(`Initialization Error: Critical UI element "${elName}" not found! Please check HTML IDs.`); if (document.getElementById('global-message-area')) { showGlobalMessage("Page initialization failed: A critical UI element could not be found. The application may not work correctly. Please check the console for details.", "error"); } else { alert("Page initialization failed: A critical UI element could not be found. The application may not work correctly. Please check the console for details."); } return; } } if (document.getElementById('export-pdf-btn') && !exportPdfBtn) { console.warn("Optional element 'export-pdf-btn' not found, PDF export functionality will be unavailable."); } try { lobCtx = lobCanvasEl.getContext("2d"); ganttCtx = ganttCanvasEl.getContext("2d"); if (!lobCtx || !ganttCtx) { throw new Error("Canvas context failed"); } } catch (e) { console.error("Failed to get 2D context for charts:", e); showGlobalMessage("Could not initialize chart canvas. Charts will not be available.", "error"); } projectStartDateInput.addEventListener("change", (event) => { if (event.target.value) { const newStartDate = new Date(event.target.value + "T00:00:00Z"); if (!isNaN(newStartDate)) { projectStartDate = newStartDate; updateUI(); } else { showGlobalMessage("Invalid project start date entered.", "error"); console.error("Invalid date entered for project start."); } } }); wbsCodeInput.addEventListener("input", (event) => { let value = event.target.value; value = value.replace(/[^0-9.]/g, ""); value = value.replace(/^\.+/, ""); value = value.replace(/\.{2,}/g, "."); event.target.value = value; }); addDependencyBtn.addEventListener("click", () => { addDependencyRow(); }); form.addEventListener("submit", handleFormSubmit); saveProjectBtn.addEventListener('click', saveProjectToLocalStorage); loadProjectBtn.addEventListener('click', () => { populateSavedProjectsSelect(); loadProjectModal.style.display = 'flex'; deleteSavedProjectBtn.style.display = 'none'; }); 
        if(resetProjectBtn) resetProjectBtn.addEventListener('click', resetProject);
        if(exportJsonBtn) exportJsonBtn.addEventListener('click', exportProjectToJSON);
        if(importJsonBtn) importJsonBtn.addEventListener('click', () => { jsonFileInput.click(); });
        if(jsonFileInput) jsonFileInput.addEventListener('change', handleJsonFileImport);
        exportCsvBtn.addEventListener('click', exportActivitiesToCSV); if (exportPdfBtn) { exportPdfBtn.addEventListener('click', generatePdfReport); } confirmLoadProjectBtn.addEventListener('click', () => { const projectName = savedProjectsSelect.value; if (projectName) { loadSpecificProject(projectName); localStorage.setItem('lobLastOpenedProject', projectName); loadProjectModal.style.display = 'none'; } else { showGlobalMessage("Please select a project to load.", "info"); } }); cancelLoadProjectBtn.addEventListener('click', () => { loadProjectModal.style.display = 'none'; }); deleteSavedProjectBtn.addEventListener('click', () => { const projectName = savedProjectsSelect.value; if (projectName && confirm(`Are you sure you want to delete project "${projectName}"? This cannot be undone.`)) { deleteSpecificProject(projectName); populateSavedProjectsSelect(); deleteSavedProjectBtn.style.display = 'none'; if (savedProjectsSelect.options.length <= 1) { loadProjectModal.style.display = 'none'; } if (localStorage.getItem('lobLastOpenedProject') === projectName) { localStorage.removeItem('lobLastOpenedProject'); } } }); savedProjectsSelect.addEventListener('change', function() { deleteSavedProjectBtn.style.display = this.value ? 'inline-flex' : 'none'; }); const today = new Date(); const offset = today.getTimezoneOffset(); const todayLocal = new Date(today.getTime() - (offset * 60 * 1000)); if (!projectStartDateInput.value) { projectStartDateInput.value = todayLocal.toISOString().split("T")[0]; } projectStartDate = new Date(projectStartDateInput.value + "T00:00:00Z"); console.log("Initial Project Start Date set to:", projectStartDate); loadProjectFromLocalStorage(); if (activities.length === 0 && !localStorage.getItem('lobLastOpenedProject') && !(JSON.parse(localStorage.getItem(LOB_PROJECT_INDEX_KEY) || '[]')).length) { updateUI(); } console.log("LOB application initialization complete."); });
  </script>
</body>
</html>
